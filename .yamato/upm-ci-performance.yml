{% metadata_file .yamato/environments.yml %}

---

{% for editor in performance_editors %}
{% for suite in performance_suites %}
{% for project in projects %}
{{project.name}}_linux_{{suite.name}}_{{editor.version}}:
  name : {{project.name}} {{ suite.display_name }} performance tests ({{ editor.version }}, Linux)
  agent:
    type: Unity::VM::GPU
    model: rtx2080
    image: package-ci/ubuntu:v3.6.0-1145766
    flavor: b1.large
  variables:
    PATH: /root/.local/bin:/home/bokken/bin:/home/bokken/.local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin:/sbin:/home/bokken/.npm-global/bin
  commands:
    - git submodule update --init --recursive
    - pip install unity-downloader-cli --index-url https://artifactory.prd.it.unity3d.com/artifactory/api/pypi/pypi/simple --upgrade --user
    - git clone git@github.cds.internal.unity3d.com:unity/utr.git utr
    - unity-downloader-cli -u {{ editor.version }} -c editor -c StandaloneSupport-IL2CPP -c Linux --wait --published
    {% if suite.name == "standalone" %}
    - DISPLAY=:0.0 utr/utr --testproject=./{{project.name}} --editor-location=.Editor --artifacts_path=test-results --stdout-filter=minimal --extra-editor-arg="--force-vulkan" {{suite.args}}StandaloneLinux64 --category="Performance" --report-performance-data --performance-project-id=com.unity.perception --zero-tests-are-ok=1
    {% else %}
    - DISPLAY=:0.0 utr/utr --testproject=./{{project.name}} --editor-location=.Editor --artifacts_path=test-results --stdout-filter=minimal --extra-editor-arg="--force-vulkan" {{suite.args}} --category="Performance" --report-performance-data --performance-project-id=com.unity.perception --zero-tests-are-ok=1
    {% endif %}
  artifacts:
    logs:
      paths:
        - "test-results/**/*"
{% endfor %}
{% endfor %}
{% endfor %}

{% for editor in performance_editors %}
{% for suite in performance_suites %}
{% for project in projects %}
{{project.name}}_windows_{{suite.name}}_{{editor.version}}:
  name : {{project.name}} {{ suite.display_name }} performance tests ({{ editor.version }}, Windows)
  agent:
    type: Unity::VM::GPU
    model: rtx2080
    image: graphics-foundation/win10-dxr:stable
    flavor: b1.large
  commands:
    - git submodule update --init --recursive
    - git clone git@github.cds.internal.unity3d.com:unity/utr.git utr
    - pip install unity-downloader-cli --index-url https://artifactory.prd.it.unity3d.com/artifactory/api/pypi/pypi/simple --upgrade
    - unity-downloader-cli -u {{ editor.version }} -c editor -c StandaloneSupport-IL2CPP -c Linux --wait --published
    {% if suite.name == "standalone" %}
    - utr/utr --testproject=./{{project.name}} --editor-location=./.Editor --artifacts_path=test-results --stdout-filter=minimal --extra-editor-arg="--force-d3d11" {{suite.args}}StandaloneWindows64 --category="Performance" --report-performance-data --performance-project-id=com.unity.perception --zero-tests-are-ok=1
    {% else %}
    - utr/utr --testproject=./{{project.name}} --editor-location=./.Editor --artifacts_path=test-results --stdout-filter=minimal --extra-editor-arg="--force-d3d11" {{suite.args}} --category="Performance" --report-performance-data --performance-project-id=com.unity.perception --zero-tests-are-ok=1
    {% endif %}
  artifacts:
    logs:
      paths:
        - "test-results/**/*"
{% endfor %}
{% endfor %}
{% endfor %}

{% for editor in performance_editors %}
{% for suite in performance_suites %}
{% for project in projects %}
{{project.name}}_mac_{{suite.name}}_{{editor.version}}:
  name : {{project.name}} {{ suite.display_name }} performance tests ({{ editor.version }}, Mac)
  agent:
    type: Unity::metal::macmini
    image: slough-ops/macos-10.14-base
    flavor: b1.medium
  commands:
    - git submodule update --init --recursive
    - pip3 config set global.index-url https://artifactory.prd.it.unity3d.com/artifactory/api/pypi/pypi/simple
    - pip3 install unity-downloader-cli --index-url https://artifactory.prd.it.unity3d.com/artifactory/api/pypi/pypi/simple --upgrade --user
    - git clone git@github.cds.internal.unity3d.com:unity/utr.git utr
    - $(/usr/local/bin/python3 -m site --user-base)/bin/unity-downloader-cli -u {{ editor.version }} -c editor -c StandaloneSupport-IL2CPP --wait --published
    {% if suite.name == "standalone" %}
    - utr/utr --testproject=./{{project.name}} --editor-location=./.Editor --artifacts_path=test-results --stdout-filter=minimal --extra-editor-arg="--force-metal" {{suite.args}}StandaloneOSX --category="Performance" --report-performance-data --performance-project-id=com.unity.perception --zero-tests-are-ok=1
    {% else %}
    - utr/utr --testproject=./{{project.name}} --editor-location=./.Editor --artifacts_path=test-results --stdout-filter=minimal --extra-editor-arg="--force-metal" {{suite.args}} --category="Performance" --report-performance-data --performance-project-id=com.unity.perception --zero-tests-are-ok=1
    {% endif %}
  artifacts:
    logs:
      paths:
        - "test-results/**/*"
{% endfor %}
{% endfor %}
{% endfor %}

# Not including OSX because the only OSX platform on Bokken with a GPU is a Mac Mini, of which there are only a few and setting up Yamato jobs is very complicated.

# {% for variant in package_variants %}
# {% for editor in complete_editors %}
# code_coverage_win_{{editor.version}}:
#   name: Code Coverage Report - Windows
#   agent:
#     type: Unity::VM
#     image: package-ci/win10:stable
#     flavor: b1.large
#   commands:
#     - npm install upm-ci-utils@stable -g --registry https://artifactory.prd.cds.internal.unity3d.com/artifactory/api/npm/upm-npm
#     - upm-ci package test --unity-version {{editor.version}} --enable-code-coverage --code-coverage-options 'enableCyclomaticComplexity;generateHtmlReport'
#   artifacts:
#     logs:
#       paths:
#         - "upm-ci~/test-results/**/*"
#   dependencies:
#     - .yamato/upm-ci-full.yml#pack_{{ variant.name }}
# {% endfor %}
# {% endfor %}
